name: Tests

on:
    workflow_dispatch:
    push:
        branches: [main]
        paths:
            - "**.py"
            - "pixi.toml"
            - "pyproject.toml"
    pull_request:
        branches: [main]

jobs:
    # Separate job for linting (runs faster in parallel)
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up pixi
              uses: prefix-dev/setup-pixi@v0.8.1
              with:
                  pixi-version: latest
                  environments: ci
                  locked: false
                  cache: false

            - name: Run ruff check
              run: pixi run -e ci ruff-check

            - name: Run ruff format check
              run: pixi run -e ci ruff-format

    # Separate job for type checking
    type-check:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up pixi
              uses: prefix-dev/setup-pixi@v0.8.1
              with:
                  pixi-version: latest
                  environments: ci
                  locked: false
                  cache: false

            - name: Run type check
              run: pixi run -e ci type-check

    # Main test job
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up pixi
              uses: prefix-dev/setup-pixi@v0.8.1
              with:
                  pixi-version: latest
                  environments: ci
                  locked: false
                  cache: false

            - name: Run tests
              run: |
                  pixi run -e ci pytest tests/ \
                    -v \
                    --tb=short \
                    --durations=10 \
                    --color=yes \
                    --strict-markers \
                    --maxfail=5 \
                    -ra

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results
                  path: .pytest_cache/

            - name: Test Summary
              if: always()
              run: |
                  echo "### Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "Exit code: $?" >> $GITHUB_STEP_SUMMARY
